<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESP32 控制面板</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    .tab {
      display: none;
    }
    .tab.active {
      display: block;
    }
    .tabs button {
      margin-right: 10px;
    }
    .io-block {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h2>ESP32 自動控制系統</h2>
  <div class="tabs">
    <button onclick="showTab('settings')">設定</button>
    <button onclick="showTab('control')">控制</button>
    <button onclick="showTab('logic')">邏輯</button>
  </div>

  <div id="settings" class="tab active">
    <h3>GPIO 設定</h3>
    <div id="settings-content"></div>
  </div>

  <div id="control" class="tab">
    <h3>控制面板</h3>
    <div id="control-content"></div>
  </div>

  <div id="logic" class="tab">
    <h3>邏輯設定</h3>
    <textarea id="logic-text" rows="5" style="width:100%"></textarea><br />
    <button onclick="saveLogic()">儲存邏輯</button>
  </div>

  <script>
    const clientId = 'esp32_webui_' + Math.random().toString(16).substr(2, 8);
    const host = 'wss://broker.mqttgo.io:8084/mqtt';
    const topicPrefix = 'esp32/control/';

    const client = mqtt.connect(host, { clientId });

    client.on('connect', () => {
      console.log('MQTT 已連線');
      client.subscribe(topicPrefix + '#');
    });

    client.on('message', (topic, message) => {
      const payload = JSON.parse(message.toString());
      if (topic.endsWith('/state')) updateState(payload);
    });

    function showTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    }

    function updateState(data) {
      const control = document.getElementById('control-content');
      control.innerHTML = '';
      data.forEach((io, index) => {
        const div = document.createElement('div');
        div.className = 'io-block';
        div.innerHTML = `<strong>${io.name} (${io.mode})</strong><br />
        狀態：${io.value}<br />
        <button onclick="toggleIO(${index})">切換</button>`;
        control.appendChild(div);
      });
    }

    function toggleIO(index) {
      client.publish(topicPrefix + 'toggle', JSON.stringify({ index }));
    }

    function saveLogic() {
      const logic = document.getElementById('logic-text').value;
      client.publish(topicPrefix + 'logic', JSON.stringify({ logic }));
    }
  </script>
</body>
</html>
