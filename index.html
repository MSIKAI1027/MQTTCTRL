<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 GPIO è¨­å®š</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
</head>
<body class="p-4">
  <h3>ESP32 GPIO æ§åˆ¶ä»‹é¢</h3>
  <form id="gpioForm" class="table-responsive">
    <table class="table table-bordered align-middle text-center">
      <thead>
        <tr>
          <th>GPIO</th>
          <th>æ¨¡å¼</th>
          <th>ç‹€æ…‹</th>
        </tr>
      </thead>
      <tbody>
        <!-- å‹•æ…‹ç”¢ç”Ÿ 10 åˆ— -->
        <script>
          for (let i = 0; i < 10; i++) {
            document.write(`
              <tr>
                <td><input type="number" class="form-control" name="pin${i}" min="0" max="39" required></td>
                <td>
                  <select class="form-select" name="mode${i}" onchange="toggleState(this, ${i})">
                    <option value="output">output</option>
                    <option value="input">input</option>
                  </select>
                </td>
                <td>
                  <select class="form-select" name="state${i}" id="state${i}">
                    <option value="high">high</option>
                    <option value="low">low</option>
                  </select>
                </td>
              </tr>
            `);
          }
        </script>
      </tbody>
    </table>
    <button type="submit" class="btn btn-primary">é€å‡ºè¨­å®š</button>
  </form>

  <pre class="mt-4" id="log">é€£ç·šä¸­...</pre>

  <script>
    const client = mqtt.connect("wss://broker.mqttgo.io:8084/mqtt");
    const log = (msg) => {
      document.getElementById("log").textContent += `\n${msg}`;
    };

    client.on("connect", () => {
      log("âœ… å·²é€£ç·š MQTT broker");
      client.subscribe("esp32/gpio_status", () => {
        log("ğŸ“¥ è¨‚é–± esp32/gpio_status");
      });
    });

    client.on("message", (topic, message) => {
      log(`ğŸ“¨ ${topic}: ${message}`);
    });

    document.getElementById("gpioForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const form = e.target;
      const data = { gpio: [] };
      for (let i = 0; i < 10; i++) {
        const pin = form[`pin${i}`].value;
        const mode = form[`mode${i}`].value;
        const state = form[`state${i}`].value;
        if (pin !== "") {
          const item = { pin: Number(pin), mode: mode };
          if (mode === "output") item.state = state;
          data.gpio.push(item);
        }
      }
      const payload = JSON.stringify(data);
      client.publish("esp32/gpio_control", payload);
      log(`ğŸ“¤ ç™¼é€ JSON:\n${payload}`);
    });

    function toggleState(selectEl, index) {
      const stateEl = document.getElementById("state" + index);
      stateEl.disabled = (selectEl.value === "input");
    }
  </script>
</body>
</html>
