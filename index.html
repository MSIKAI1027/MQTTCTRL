<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32 控制面板</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .status-led {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-block;
    }
    .led-on { background-color: red; }
    .led-off { background-color: green; }
  </style>
  <!-- MQTT.js for WebSocket -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
<div class="container mt-4">
  <ul class="nav nav-tabs" id="mainTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">設定</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="control-tab" data-bs-toggle="tab" data-bs-target="#control" type="button" role="tab">控制</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="logic-tab" data-bs-toggle="tab" data-bs-target="#logic" type="button" role="tab">邏輯</button>
    </li>
  </ul>
  <div class="tab-content mt-3">
    <!-- 設定頁面 -->
    <div class="tab-pane fade show active" id="settings" role="tabpanel">
      <form id="settingsForm">
        <table class="table table-bordered">
          <thead><tr><th>#</th><th>GPIO 名稱</th><th>模式</th><th>控制類型</th><th>單位</th></thead>
          <tbody id="settingsTableBody"></tbody>
        </table>
        <button type="submit" class="btn btn-primary">儲存設定</button>
      </form>
    </div>
    <!-- 控制頁面 -->
    <div class="tab-pane fade" id="control" role="tabpanel">
      <table class="table table-bordered">
        <thead><tr><th>#</th><th>GPIO 名稱</th><th>模式</th><th>狀態/控制</th><th>控制模式</th><th>排程</th></thead>
        <tbody id="controlTableBody"></tbody>
      </table>
    </div>
    <!-- 邏輯頁面 -->
    <div class="tab-pane fade" id="logic" role="tabpanel">
      <form id="logicForm">
        <div class="mb-3">
          <label for="logicRule" class="form-label">邏輯條件 (範例: 如果 GPIO1 = HIGH，則啟動 GPIO5)</label>
          <textarea id="logicRule" class="form-control" rows="5"></textarea>
        </div>
        <button type="submit" class="btn btn-success">儲存邏輯</button>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// 基本設定
const ioCount = 10;
const gpioMap = [12, 14, 27, 26, 25, 33, 32, 4, 5, 18];
let currentConfig = [];

// MQTT 初始化
const mqttHost = 'ws://broker.mqttgo.io:8083/mqtt';
const clientId = 'web_' + Math.random().toString(16).substr(2, 8);
const mqttOptions = {
  keepalive: 60,
  clientId,
  protocolId: 'MQTT',
  protocolVersion: 4,
  clean: true,
  reconnectPeriod: 1000,
  connectTimeout: 30 * 1000,
};
const client = mqtt.connect(mqttHost, mqttOptions);

client.on('connect', () => {
  console.log('MQTT 已連線：', clientId);
  client.subscribe('esp32/io/status');
  client.subscribe('esp32/logic/status');
});
client.on('error', err => console.error('MQTT 錯誤：', err));

// 渲染設定表與控制表
function renderSettingsTable() {
  const tbody = document.getElementById('settingsTableBody');
  tbody.innerHTML = '';
  for (let i = 0; i < ioCount; i++) {
    tbody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td><input type="text" class="form-control" name="gpioName${i}" placeholder="GPIO${gpioMap[i]}"></td>
        <td><select class="form-select" name="mode${i}" id="mode${i}" onchange="updateControlFields(${i})">
            <option value="input">Input</option>
            <option value="output">Output</option>
          </select></td>
        <td><select class="form-select" name="controlType${i}" id="controlType${i}">
            <option value="digital">數位</option>
            <option value="analog">類比</option>
          </select></td>
        <td><input type="text" class="form-control" name="unit${i}" id="unit${i}" placeholder="單位"></td>
      </tr>`;
  }
}

function renderControlTable(ioConfig = []) {
  const tbody = document.getElementById('controlTableBody');
  tbody.innerHTML = '';
  ioConfig.forEach((cfg, i) => {
    const mode = cfg.mode;
    const type = cfg.type;
    const value = cfg.value || 0;
    const name = cfg.name;
    const controlMode = cfg.controlMode || 'auto';
    let statusHTML = '';
    let modeSelector = '';

    if (mode === 'output') {
      statusHTML = `<button class="btn btn-sm btn-${value? 'danger':'secondary'}" onclick="handleOutputToggle(${i}, ${value})">${value? '關閉':'開啟'}</button>`;
    } else {
      if (type === 'digital') {
        statusHTML = `<span class="status-led ${value? 'led-on':'led-off'}"></span>`;
      } else {
        statusHTML = `${value} ${cfg.unit || 'V'}`;
      }
      modeSelector = `<select class="form-select form-select-sm w-auto" onchange="handleModeChange(${i}, this.value)">
                        <option value="auto" ${controlMode==='auto'?'selected':''}>自動</option>
                        <option value="remote" ${controlMode==='remote'?'selected':''}>遠端</option>
                      </select>`;
    }

    tbody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${name}</td>
        <td>${mode.toUpperCase()}</td>
        <td>${statusHTML}</td>
        <td>${mode==='input'? modeSelector:'—'}</td>
        <td><button class="btn btn-outline-primary btn-sm">設定排程</button></td>
      </tr>`;
  });
}

function updateControlFields(index) {
  const mode = document.getElementById(`mode${index}`).value;
  const ctrl = document.getElementById(`controlType${index}`);
  const unit = document.getElementById(`unit${index}`);
  const isInput = mode === 'input';
  ctrl.disabled = !isInput;
  unit.disabled = !isInput;
  if (!isInput) { ctrl.value = ''; unit.value = ''; }
}

function handleModeChange(index, val) {
  console.log(`GPIO${index} 模式：${val}`);
  client.publish(`esp32/io/mode/${index}`, val);
}

window.handleOutputToggle = (idx, current) => {
  const newVal = current? 0:1;
  client.publish(`esp32/io/set/${idx}`, JSON.stringify({value: newVal}));
  console.log(`GPIO${idx} => ${newVal}`);
};

// 表單事件
document.getElementById('settingsForm').addEventListener('submit', e => {
  e.preventDefault();
  const cfg = [];
  for (let i=0; i<ioCount; i++) {
    cfg.push({
      index: i,
      name: e.target[`gpioName${i}`].value || `GPIO${gpioMap[i]}`,
      mode: e.target[`mode${i}`].value,
      type: e.target[`controlType${i}`].value,
      unit: e.target[`unit${i}`].value,
      value: 0,
      controlMode: 'auto'
    });
  }
  currentConfig = cfg;
  client.publish('esp32/io/config', JSON.stringify(cfg));
  renderControlTable(currentConfig);
});

document.getElementById('logicForm').addEventListener('submit', e => {
  e.preventDefault();
  const rule = document.getElementById('logicRule').value.trim();
  client.publish('esp32/logic/rule', rule);
});

// 接收訊息
client.on('message', (topic, payload) => {
  const msg = payload.toString();
  if (topic === 'esp32/io/status') {
    const stats = JSON.parse(msg);
    const updated = currentConfig.map(c => ({
      ...c,
      value: stats.find(s => s.index===c.index)?.value || 0
    }));
    renderControlTable(updated);
  }
  if (topic === 'esp32/logic/status') {
    console.log('邏輯執行：', msg);
  }
});

// 初始渲染
renderSettingsTable();
renderControlTable();
</script>
</body>
</html>
