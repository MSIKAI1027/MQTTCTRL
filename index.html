<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32 æ§åˆ¶é¢æ¿</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .status-led {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-block;
    }
    .led-on { background-color: red; }
    .led-off { background-color: green; }
  </style>
</head>
<body>
<div class="container mt-4">
  <ul class="nav nav-tabs" id="mainTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">è¨­å®š</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="control-tab" data-bs-toggle="tab" data-bs-target="#control" type="button" role="tab">æ§åˆ¶</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="logic-tab" data-bs-toggle="tab" data-bs-target="#logic" type="button" role="tab">é‚è¼¯</button>
    </li>
  </ul>
  <div class="tab-content mt-3">
    <!-- è¨­å®šé é¢ -->
    <div class="tab-pane fade show active" id="settings" role="tabpanel">
      <form id="settingsForm">
        <table class="table table-bordered">
          <thead><tr><th>#</th><th>GPIO åç¨±</th><th>æ¨¡å¼</th><th>æ§åˆ¶é¡å‹</th><th>å–®ä½</th></tr></thead>
          <tbody id="settingsTableBody"></tbody>
        </table>
        <button type="submit" class="btn btn-primary">å„²å­˜è¨­å®š</button>
      </form>
    </div>
    <!-- æ§åˆ¶é é¢ -->
    <div class="tab-pane fade" id="control" role="tabpanel">
      <table class="table table-bordered">
        <thead><tr><th>#</th><th>GPIO åç¨±</th><th>æ¨¡å¼</th><th>ç‹€æ…‹/æ§åˆ¶</th><th>æ§åˆ¶æ¨¡å¼</th><th>æ’ç¨‹</th></tr></thead>
        <tbody id="controlTableBody"></tbody>
      </table>
    </div>
    <!-- é‚è¼¯é é¢ -->
    <div class="tab-pane fade" id="logic" role="tabpanel">
      <form id="logicForm">
        <div class="mb-3">
          <label for="logicRule" class="form-label">é‚è¼¯æ¢ä»¶ (ç¯„ä¾‹: å¦‚æœ GPIO1 = HIGHï¼Œå‰‡å•Ÿå‹• GPIO5)</label>
          <textarea id="logicRule" class="form-control" rows="5"></textarea>
        </div>
        <button type="submit" class="btn btn-success">å„²å­˜é‚è¼¯</button>
      </form>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.0/mqttws31.min.js"></script>
<script>
  // åˆå§‹åŒ– MQTT å®¢æˆ¶ç«¯
  const clientID = "webClient_" + Math.floor(Math.random() * 10000);
  const client = new Paho.MQTT.Client("broker.mqttgo.io", 8084, clientID);

  client.connect({
    onSuccess: function () {
      console.log("âœ… å·²é€£æ¥åˆ° MQTT broker");
    },
    useSSL: true
  });

  const ioCount = 10;
  const gpioMap = [12, 14, 27, 26, 25, 33, 32, 4, 5, 18];

  function renderSettingsTable() {
    const tbody = document.getElementById('settingsTableBody');
    tbody.innerHTML = '';
    for (let i = 0; i < ioCount; i++) {
      tbody.innerHTML += `
        <tr>
          <td>${i + 1}</td>
          <td>
            <input type="text" class="form-control" name="gpioName${i}" placeholder="GPIO${gpioMap[i]}">
          </td>
          <td>
            <select class="form-select" name="mode${i}" id="mode${i}" onchange="updateControlFields(${i})">
              <option value="input">Input</option>
              <option value="output">Output</option>
            </select>
          </td>
          <td>
            <select class="form-select" name="controlType${i}" id="controlType${i}">
              <option value="digital">æ•¸ä½</option>
              <option value="analog">é¡æ¯”</option>
            </select>
          </td>
          <td>
            <input type="text" class="form-control" name="unit${i}" id="unit${i}" placeholder="å–®ä½">
          </td>
        </tr>
      `;
    }
  }

  function renderControlTable(ioConfig = []) {
    const tbody = document.getElementById('controlTableBody');
    tbody.innerHTML = '';
    for (let i = 0; i < ioCount; i++) {
      const mode = ioConfig[i]?.mode || 'input';
      const type = ioConfig[i]?.type || 'digital';
      const value = ioConfig[i]?.value || 0;
      const name = ioConfig[i]?.name || `GPIO${gpioMap[i]}`;
      const controlMode = ioConfig[i]?.controlMode || 'auto';
      let statusHTML = '';
      let modeLabel = controlMode === 'remote' ? 'é ç«¯' : 'è‡ªå‹•';
      let modeSelector = '';

      if (mode === 'output') {
        statusHTML = `
          <button class="btn btn-sm btn-${value ? 'danger' : 'secondary'}">
            ${value ? 'é—œé–‰' : 'é–‹å•Ÿ'}
          </button>`;
      } else {
        if (type === 'digital') {
          statusHTML = `
            <span class="status-led ${value ? 'led-on' : 'led-off'}"></span>
          `;
        } else {
          const unit = ioConfig[i]?.unit || 'V';
          statusHTML = `${value} ${unit}`;
        }
        modeSelector = `
          <select class="form-select form-select-sm w-auto" onchange="handleModeChange(${i}, this.value)">
            <option value="auto" ${controlMode === 'auto' ? 'selected' : ''}>è‡ªå‹•</option>
            <option value="remote" ${controlMode === 'remote' ? 'selected' : ''}>é ç«¯</option>
          </select>
        `;
      }

      tbody.innerHTML += `
        <tr>
          <td>${i + 1}</td>
          <td>${name}</td>
          <td>${mode.toUpperCase()}</td>
          <td>${statusHTML}</td>
          <td>${mode === 'input' ? modeSelector : 'â€”'}</td>
          <td><button class="btn btn-outline-primary btn-sm">è¨­å®šæ’ç¨‹</button></td>
        </tr>
      `;
    }
  }

  function updateControlFields(index) {
    const mode = document.getElementById(`mode${index}`).value;
    const controlTypeSelect = document.getElementById(`controlType${index}`);
    const unitInput = document.getElementById(`unit${index}`);
    const isInput = mode === 'input';
    controlTypeSelect.disabled = !isInput;
    unitInput.disabled = !isInput;
    if (!isInput) {
      controlTypeSelect.value = '';
      unitInput.value = '';
    }
  }

  function handleModeChange(index, value) {
    console.log(`GPIO ${index} æ¨¡å¼æ”¹ç‚ºï¼š${value}`);
    // TODO: å‘ ESP32 ç™¼é€æ¨¡å¼è®Šæ›´æŒ‡ä»¤èˆ‡å¼·åˆ¶ç‹€æ…‹åˆ‡æ›ï¼ˆè‹¥ç‚º remoteï¼‰
  }

  // ç™¼é€ MQTT æ§åˆ¶æŒ‡ä»¤
  function sendCommand(gpioIndex, command) {
    const topic = `esp32/gpio/${gpioMap[gpioIndex]}`;
    const message = new Paho.MQTT.Message(command);
    message.destinationName = topic;
    client.send(message);
    console.log(`ğŸ“¤ ç™¼é€å‘½ä»¤: ${command} åˆ° topic: ${topic}`);
  }

  // ç•¶ä½¿ç”¨è€…é»æ“Šé–‹é—œæŒ‰éˆ•æ™‚
  function toggleGPIOState(index, currentState) {
    const newState = currentState === 'ON' ? 'OFF' : 'ON';
    sendCommand(index, newState);
  }

  renderSettingsTable();
  renderControlTable();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
